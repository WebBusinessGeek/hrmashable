<%- model_class = Blog -%>

<div class='span9'>
  <div class='row-fluid'>
    <div class="span12">
      <h6><%= @blog.category.title.upcase %></h6>
    </div>
  </div>

  <div class='row-fluid'>
    <div class="span12">
      <h2><%= @blog.title.titleize %></h2>
    </div>
  </div>

  <div class='row-fluid'>
    <div class="span2">
      shares
    </div>
  </div>

  <div class='row-fluid'>
    <div class="span12">
      <%= image_tag(@blog.main_pic.url, width: '100%') if @blog.main_pic.present? %>
    </div>
  </div>

  <div class='row-fluid'>
    <div class='span2 offset2'>
      <%= image_tag(@blog.author.profile_pic) if @blog.author.profile_pic.present? %>
      </br
      By <%= @blog.author.full_name %>
      </br>
      <hr>
      <%= last_updated_at(@blog.updated_at) %>
    </div>

    <div class='span8'>
      <%= simple_format(@blog.description) if @blog.description.present? %>
    </div>
  </div>

  <div class='row-fluid'>
    <div class='span8 offset4'>
      <b>Topics:
        <% if @blog.tags.present? %>
          <% @blog.tags.each do |tag| %>
            <%= tag.title.upcase %> <% if @blog.tags.last != tag %>,<% end %>
          <% end %>
        <% end %>
      </b>
    </div>
  </div>

  <div class='row-fluid'>
    <div class="span12">
      <hr>
    </div>
  </div>

  <div class='row-fluid'>
    <div class='span8 offset4'>
      <% if !current_user %>
        <%= link_to 'Sign in', 'javascript:void(0);', :'data-toggle' => 'modal', :'data-target' => '#loginModal' %>
      <% end %>
      <span class='pull-right'>
        <b><%= @blog.users.count %> people following</b>
      </span>
    </div>
  </div>

  <div class='row-fluid'>
    <div class='span8 offset4'>
      <textarea rows='4' class='field span12' id='comment_area'></textarea>
    </div>
  </div>

  <div class='row-fluid'>
    <div class='span8 offset4'>
      <span class='pull-left' id='follow_status'>
        <% if current_user %>
          <% if current_user.following_blog?(@blog.id) %>
            <%#= link_to_function '+Unfollow', 'unfollow_blog()', class: 'btn btn-default' %>
            <%= link_to '+Unfollow', unfollow_blog_path(@blog.id), class: 'btn btn-default' %>
          <% else %>
            <%#= link_to_function '+Follow', 'follow_blog()', class: 'btn btn-default' %>
            <%= link_to '+Follow', follow_blog_path(@blog.id), class: 'btn btn-default' %>
          <% end %>
        <% else %>
          <%= link_to '+Follow', 'javascript:void(0);', class: 'btn btn-default', :'data-toggle' => 'modal', :'data-target' => '#loginModal' %>
        <% end %>
      </span>
      <span class='pull-right'>
        <% if current_user %>
          <%= link_to_function 'POST COMMENT', 'postComment()', class: 'btn btn-default' %>
        <% else %>
          <%= link_to 'POST COMMENT', 'javascript:void(0);', class: 'btn btn-default', :'data-toggle' => 'modal', :'data-target' => '#loginModal' %>
        <% end %>
      </span>
    </div>
  </div>

  <div class='row-fluid' style='padding-top: 2em;'>
    <div class='span8 offset4'>
      <% if (!params[:basis].present? && !params[:direction].present?) || (params[:direction].present? && params[:direction].downcase == 'desc') %>
        <strong><%= link_to_unless_current 'Newest', '?direction=desc' %></strong> |
      <% else %>
        <%= link_to 'Newest', '?direction=desc' %> |
      <% end %>

      <% if params[:direction].present? && params[:direction].downcase == 'asc' %>
        <strong><%= link_to 'Oldest', '?direction=asc' %></strong> |
      <% else %>
        <%= link_to 'Oldest', '?direction=asc' %> |
      <% end %>

      <% if params[:basis].present? && params[:basis].downcase == 'top_comments' %>
        <strong><%= link_to 'Top Comments', '?basis=top_comments' %></strong> |
      <% else %>
        <%= link_to 'Top Comments', '?basis=top_comments' %> |
      <% end %>

      <hr style='margin: 5px; margin-bottom: 1em;'>

      <% @comments.each do |comment| %>
        <div class='row-fluid'>
          <div class='span1'>
            <%= image_tag(comment.user.profile_pic, width: '100%') if comment.user.present? %>
          </div>
          <div class='span11'>
            <div class='row-fluid'>
              <div class='span4'>
                <%= comment.user.full_name if comment.user.present? %>
              </div>
              <div class='pull-right'>
                <%= last_updated_at(comment.updated_at) %>
              </div>
            </div>
            <div class='row-fluid'>
              <div class='span12'>
                <%= simple_format(comment.message) if comment.message.present? %>
              </div>
            </div>
            <div class='row-fluid'>
              <div class='span6'>
                <% if current_user %>
                  <%= link_to 'Share', 'javascript:void(0);' %>
                  <%#= link_to_function 'Delete', "deleteComment(#{comment.id})", style: 'margin-left: 0.4em;' %>
                  <%= link_to 'Delete', delete_comment_blog_path(@blog.id, comment_id: comment.id), style: 'margin-left: 0.4em;' %>
                <% else %>
                  <%= link_to 'Share', 'javascript:void(0);', :'data-toggle' => 'modal', :'data-target' => '#loginModal' %>
                  <%= link_to 'Delete', 'javascript:void(0);', :'data-toggle' => 'modal', :'data-target' => '#loginModal' %>
                <% end %>
              </div>
              <div class='pull-right'>
                <% if current_user %>
                  <% if current_user.is_like(comment) %>
                    <!-- <%#= link_to_function 'Unlike', "unlikeComment(#{comment.id})" %> / -->
                    <%= link_to 'Unlike', unlike_comment_blog_path(@blog.id, comment_id: comment.id) %> /
                  <% else %>
                    <!-- <%#= link_to_function 'Like', "likeComment(#{comment.id})" %> / -->
                    <%= link_to 'Like', like_comment_blog_path(@blog.id, comment_id: comment.id) %> /
                  <% end %>
                  <%= link_to_function 'Reply', "replyComment(#{comment.id})" %>
                <% else %>
                  <%= link_to 'Like', 'javascript:void(0);', :'data-toggle' => 'modal', :'data-target' => '#loginModal' %> /
                  <%= link_to 'Reply', 'javascript:void(0);', :'data-toggle' => 'modal', :'data-target' => '#loginModal' %>
                <% end %>
              </div>
            </div>

            <%= get_all_children(comment) %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class='row-fluid'>
    <div class='span12'>
      <b>More in <%= @blog.category.title.titleize if @blog.category.present? %>:</b>
    </div>
  </div>

  <div class='row-fluid'>
    <div class="span12">
      <hr>
    </div>
  </div>
</div>

<%= content_for :custom_javascripts do %>
  function follow_blog() {
    $.ajax({
      url: '<%= follow_blog_path(@blog.id) %>',
      type: 'GET',
      success: function(response) {
        $('#follow_status').html('<%= link_to_function '+Unfollow', 'unfollow_blog()', class: 'btn btn-default' %>');
      },
      error: function(response) {
        console.log(response);
      }
    });
  }

  function unfollow_blog() {
    $.ajax({
      url: '<%= unfollow_blog_path(@blog.id) %>',
      type: 'GET',
      success: function(response) {
        $('#follow_status').html('<%= link_to_function '+Follow', 'follow_blog()', class: 'btn btn-default' %>');
      },
      error: function(response) {
        console.log(response);
      }
    });
  }

  function postComment() {
    msg = $('#comment_area').val().trim();

    if(msg != '') {
      // $.ajax({
      //   url: '<%= post_comment_blog_path(@blog.id) %>',
      //   type: 'GET',
      //   data: {
      //     message: msg
      //   },
      //   success: function(response) {
      //     $('#follow_status').html('<%= link_to_function '+Follow', 'follow_blog()', class: 'btn btn-default' %>');
      //   },
      //   error: function(response) {
      //     console.log(response);
      //   }
      // });
      location.href = '/blogs/<%= @blog.id %>/post_comment?message=' + msg;
    }
    else {
      alert('It seems you\'re attempting to post an empty comment.')
    }
  }

  function replyComment(id) {
    msg = $('#comment_area').val().trim();

    if(msg != '') {
      // $.ajax({
      //   url: '<%= post_comment_blog_path(@blog.id) %>',
      //   type: 'GET',
      //   data: {
      //     message: msg,
      //     parent_comment_id: id
      //   },
      //   success: function(response) {
      //     $('#follow_status').html('<%= link_to_function '+Follow', 'follow_blog()', class: 'btn btn-default' %>');
      //   },
      //   error: function(response) {
      //     console.log(response);
      //   }
      // });
      location.href = '/blogs/<%= @blog.id %>/post_comment?message=' + msg + '&parent_comment_id=' + id;
    }
    else {
      alert('It seems you\'re attempting to post an empty comment.')
    }
  }

  function deleteComment(id) {
    $.ajax({
      url: '<%= delete_comment_blog_path(@blog.id) %>',
      type: 'GET',
      data: {
        comment_id: id
      },
      success: function(response) {
        $('#follow_status').html('<%= link_to_function '+Follow', 'follow_blog()', class: 'btn btn-default' %>');
      },
      error: function(response) {
        console.log(response);
      }
    });
  }

  function likeComment(id) {
    $.ajax({
      url: '<%= like_comment_blog_path(@blog.id) %>',
      type: 'GET',
      data: {
        comment_id: id
      },
      success: function(response) {
        console.log(response);
      },
      error: function(response) {
        console.log(response);
      }
    });
  }

  function unlikeComment(id) {
    $.ajax({
      url: '<%= unlike_comment_blog_path(@blog.id) %>',
      type: 'GET',
      data: {
        comment_id: id
      },
      success: function(response) {
        console.log(response);
      },
      error: function(response) {
        console.log(response);
      }
    });
  }
<% end %>